rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is accessing their own data
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Riders collection: Riders can read/write their own profile
    match /Riders/{userId} {
      allow read, write: if isOwner(userId);
      
      // KnownPlaces subcollection
      match /KnownPlaces/{placeId} {
        allow read, write: if isOwner(userId);
      }
      
      // Rider's cards subcollection
      match /cards/{cardId} {
        allow read, write: if isOwner(userId);
      }
      
      // Rider's payments subcollection
      match /payments/{paymentId} {
        allow read, write: if isOwner(userId);
      }
    }

    // Drivers collection: Drivers can read/write their own profile; others can read online status/info
    match /Drivers/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }

    // Request collection: Used for active ride management
    // Both rider and driver involved in a request need full access
    match /Request/{requestId} {
      allow create: if isAuthenticated();
      allow read, update, delete: if isAuthenticated() && (
        request.auth.uid == resource.data.Rider_id || 
        request.auth.uid == resource.data.Driver_id ||
        request.auth.uid == requestId // Some parts of the app use Driver_id as requestID
      );
      
      // Chat messages within a request
      match /messages/{messageId} {
        allow read, create: if isAuthenticated();
      }
    }

    // RideHistory collection
    match /RideHistory/{historyId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.riderId || 
        request.auth.uid == resource.data.driverId
      );
    }

    // Global Messages (system chat/support)
    match /Messages/{userId} {
      allow read, write: if isOwner(userId);
      
      match /messages/{messageId} {
        allow read, write: if isOwner(userId);
      }
    }

    // Blogs/News
    match /Blogs/{blogId} {
      allow read: if isAuthenticated();
    }

    // Ratings
    match /ratings/{ratingId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
    }

    // Paystack/Payment codes
    match /paystackAuthCodes/{code} {
      allow read, write: if isAuthenticated();
    }

    // Catch-all for other user-specific ride history paths if any
    match /users/{userId}/rideHistory/{historyId} {
      allow read, write: if isOwner(userId);
    }

    // --- Added missing collections ---

    // Settings collection: Global app configuration
    match /Settings/{document} {
      allow read: if isAuthenticated();
    }

    // Wallet & Referrals
    match /WalletTransactions/{docId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || resource.data.riderId == request.auth.uid || resource.data.driverId == request.auth.uid);
      allow create: if isAuthenticated();
    }

    match /Referrals/{docId} {
      allow read: if isAuthenticated() && (resource.data.referrerId == request.auth.uid || resource.data.referredId == request.auth.uid);
      allow create: if isAuthenticated();
    }

    match /ReferralRewards/{docId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Safety & SOS
    match /EmergencyContacts/{docId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /TripShares/{docId} {
      allow read: if true; // Publicly accessible via link
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /SOSAlerts/{docId} {
      allow read, write: if isAuthenticated() && (resource.data.userId == request.auth.uid || resource.data.riderId == request.auth.uid);
    }

    match /AudioRecordings/{docId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /SafetyRatings/{docId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
    }

    match /DriverVerifications/{docId} {
      allow read: if isAuthenticated() && resource.data.driverId == request.auth.uid;
      allow create: if isAuthenticated();
    }

    // Shared Rides
    match /SharedRideOpportunities/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Admin Notifications: Users can create them, only admins (logic outside) can read
    match /AdminNotifications/{docId} {
      allow create: if isAuthenticated();
    }
  }
}
